{"version":3,"file":"js/382.8b3baef4.js","mappings":"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","sources":["webpack://graduate/./src/views/MapboxSymbolInstance.vue?0ef4","webpack://graduate/./src/utils/symbol-utils.ts","webpack://graduate/./src/views/MapboxSymbolInstance.vue","webpack://graduate/./src/views/MapboxSymbolInstance.vue?cddc"],"sourcesContent":["import { openBlock as _openBlock, createElementBlock as _createElementBlock, pushScopeId as _pushScopeId, popScopeId as _popScopeId } from \"vue\";\nconst _withScopeId = n => (_pushScopeId(\"data-v-34464bf0\"), n = n(), _popScopeId(), n);\nconst _hoisted_1 = {\n  class: \"container\",\n  ref: \"container\"\n};\nexport function render(_ctx, _cache, $props, $setup, $data, $options) {\n  return _openBlock(), _createElementBlock(\"div\", _hoisted_1, null, 512);\n}","import { CustomLayerInterface, MercatorCoordinate } from \"mapbox-gl\";\r\nimport axios from \"axios\";\r\nimport { mat4 } from \"gl-matrix\";\r\nimport { encodeFloatToDouble } from \"@/utils/common\";\r\nimport mapBoxGl from \"mapbox-gl\";\r\n\r\nexport class SymbolHandle {\r\n  vertexScript: string | null = null;\r\n  fragmentScript: string | null = null;\r\n  position: number[] = [];\r\n  simpleArray: number[] = [];\r\n  rotationArray: number[] = [];\r\n  strip: HTMLImageElement | null = null;\r\n  palette: HTMLImageElement | null = null;\r\n  simpleTexture: WebGLTexture | null = null;\r\n  paletteTexture: WebGLTexture | null = null;\r\n  number: number;\r\n  symbolPixel: number;\r\n  modelMatrix: mat4 = mat4.create();\r\n\r\n  constructor(number: number, symbolPixel: number) {\r\n    this.number = number;\r\n    this.symbolPixel = symbolPixel;\r\n    mat4.identity(this.modelMatrix);\r\n    mat4.scale(this.modelMatrix, this.modelMatrix, [symbolPixel * window.devicePixelRatio, symbolPixel * window.devicePixelRatio, 1.0]);\r\n  }\r\n\r\n  async getShader(address: string, type: \"vertex\" | \"fragment\") {\r\n    const shaderScript = await axios.get(address).then((res) => res.data);\r\n    if (type === \"vertex\") this.vertexScript = shaderScript;\r\n    else this.fragmentScript = shaderScript;\r\n  }\r\n\r\n  getTexture(address: string, type: \"strip\" | \"palette\") {\r\n    return new Promise((resolve, reject) => {\r\n      const image = new Image();\r\n      image.src = address;\r\n      image.onload = () => {\r\n        if (type === \"palette\") this.palette = image;\r\n        else this.strip = image;\r\n        resolve(null);\r\n      };\r\n    });\r\n  }\r\n\r\n  async getData(positionJsonAddress: string, infoJsonAddress: string, type?: string) {\r\n    const positionPromise = new Promise((resolve, reject) => {\r\n      axios.get(positionJsonAddress).then((res) => resolve(res.data));\r\n    });\r\n    const infoPromise = new Promise((resolve, reject) => {\r\n      axios.get(infoJsonAddress).then((res) => resolve(res.data));\r\n    });\r\n    if (type) {\r\n      return Promise.all([infoPromise, positionPromise]).then((res) => {\r\n        const arr = (res[0] as any).markers.description;\r\n        for (let i = 0; i < arr.length; i++) {\r\n          if (arr[i].name === type) {\r\n            const instanceNum = Math.ceil(arr[i].length / this.number);\r\n            for (let j = 0; j < (res[1] as any).features.length; j++) {\r\n              const item = (res[1] as any).features[j];\r\n              const coord = MercatorCoordinate.fromLngLat({\r\n                lng: item.geometry.coordinates[0],\r\n                lat: item.geometry.coordinates[1],\r\n              });\r\n              for (let k = 0; k < instanceNum; k++) {\r\n                this.simpleArray.push(arr[i].base, arr[i].length, k, arr[i].ID);\r\n                const positionX = encodeFloatToDouble(coord.x);\r\n                const positionY = encodeFloatToDouble(coord.y);\r\n                this.position.push(positionX[0], positionY[0], positionX[1], positionY[1]);\r\n                this.rotationArray.push(0);\r\n              }\r\n            }\r\n          }\r\n        }\r\n      });\r\n    } else {\r\n      return Promise.all([infoPromise, positionPromise]).then((res) => {\r\n        const arr = (res[0] as any).markers.description;\r\n\r\n        for (let j = 0; j < (res[1] as any).features.length; j++) {\r\n          let randomNumber;\r\n          do {\r\n            randomNumber = Math.floor(Math.random() * 6);\r\n          } while (randomNumber === 3);\r\n          const rotation = 360 * Math.random()\r\n          const instanceNum = Math.ceil(arr[randomNumber].length / this.number);\r\n          const item = (res[1] as any).features[j];\r\n          const coord = MercatorCoordinate.fromLngLat({\r\n            lng: item.geometry.coordinates[0],\r\n            lat: item.geometry.coordinates[1],\r\n          });\r\n          for (let k = 0; k < instanceNum; k++) {\r\n            this.simpleArray.push(arr[randomNumber].base, arr[randomNumber].length, k, arr[randomNumber].ID);\r\n            const positionX = encodeFloatToDouble(coord.x);\r\n            const positionY = encodeFloatToDouble(coord.y);\r\n            this.position.push(positionX[0], positionY[0], positionX[1], positionY[1]);\r\n            this.rotationArray.push(rotation);\r\n          }\r\n        }\r\n      });\r\n    }\r\n  }\r\n\r\n  myBindTexture(gl: WebGL2RenderingContext) {\r\n    if (this.strip && this.palette) {\r\n      this.simpleTexture = gl.createTexture();\r\n      gl.bindTexture(gl.TEXTURE_2D, this.simpleTexture);\r\n      gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, this.strip);\r\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\r\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\r\n      this.paletteTexture = gl.createTexture();\r\n      gl.bindTexture(gl.TEXTURE_2D, this.paletteTexture);\r\n      gl.texImage2D(gl.TEXTURE_2D, 0, gl.RGBA, gl.RGBA, gl.UNSIGNED_BYTE, this.palette);\r\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_S, gl.CLAMP_TO_EDGE);\r\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_WRAP_T, gl.CLAMP_TO_EDGE);\r\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MIN_FILTER, gl.LINEAR);\r\n      gl.texParameteri(gl.TEXTURE_2D, gl.TEXTURE_MAG_FILTER, gl.LINEAR);\r\n    }\r\n  }\r\n\r\n  generateCustomLayer(id: string, map: mapboxgl.Map) {\r\n    let program: WebGLProgram;\r\n    let VAO: WebGLVertexArrayObject;\r\n    const vertexScript = this.vertexScript;\r\n    const fragmentScript = this.fragmentScript;\r\n    const position = this.position;\r\n    const simpleArray = this.simpleArray;\r\n    const rotationArray = this.rotationArray;\r\n    const that = this;\r\n\r\n    const result: CustomLayerInterface = {\r\n      id: id,\r\n      type: \"custom\",\r\n      onAdd(map: mapboxgl.Map, gl: WebGL2RenderingContext) {\r\n        if (vertexScript && fragmentScript && position && simpleArray && rotationArray) {\r\n          const vertexShader = gl.createShader(gl.VERTEX_SHADER)!;\r\n          gl.shaderSource(vertexShader, vertexScript);\r\n          gl.compileShader(vertexShader);\r\n          const fragmentShader = gl.createShader(gl.FRAGMENT_SHADER)!;\r\n          gl.shaderSource(fragmentShader, fragmentScript);\r\n          gl.compileShader(fragmentShader);\r\n          program = gl.createProgram()!;\r\n          gl.attachShader(program, vertexShader);\r\n          gl.attachShader(program, fragmentShader);\r\n          gl.linkProgram(program);\r\n\r\n          VAO = gl.createVertexArray()!;\r\n          gl.bindVertexArray(VAO);\r\n          const VBO = gl.createBuffer();\r\n          gl.bindBuffer(gl.ARRAY_BUFFER, VBO);\r\n          gl.bufferData(gl.ARRAY_BUFFER, new Float32Array([...simpleArray, ...position, ...rotationArray]), gl.DYNAMIC_DRAW);\r\n          gl.enableVertexAttribArray(0);\r\n          gl.vertexAttribPointer(0, 4, gl.FLOAT, false, 4 * 4, 0);\r\n          gl.vertexAttribDivisor(0, 1);\r\n          gl.enableVertexAttribArray(1);\r\n          gl.vertexAttribPointer(1, 4, gl.FLOAT, false, 4 * 4, 4 * 4 * rotationArray.length);\r\n          gl.vertexAttribDivisor(1, 1);\r\n          gl.enableVertexAttribArray(2);\r\n          gl.vertexAttribPointer(2, 1, gl.FLOAT, false, 4, 8 * 4 * rotationArray.length);\r\n          gl.vertexAttribDivisor(2, 1);\r\n          gl.bindBuffer(gl.ARRAY_BUFFER, null);\r\n          gl.bindVertexArray(null);\r\n\r\n          that.myBindTexture.call(that, gl);\r\n        }\r\n      },\r\n      render(gl: WebGL2RenderingContext, matrix: number[]) {\r\n        gl.useProgram(program);\r\n        const uSymbolMatrix = gl.getUniformLocation(program, \"u_symbolMatrix\");\r\n        gl.uniformMatrix4fv(uSymbolMatrix, false, that.modelMatrix);\r\n        const uBufferSize = gl.getUniformLocation(program, \"u_bufferSize\");\r\n        gl.uniform2f(uBufferSize, gl.canvas.width, gl.canvas.height);\r\n        const center = map.getCenter();\r\n        const mercatorCenter = mapBoxGl.MercatorCoordinate.fromLngLat({\r\n          lng: center.lng,\r\n          lat: center.lat,\r\n        });\r\n        const mercatorCenterX = encodeFloatToDouble(mercatorCenter.x);\r\n        const mercatorCenterY = encodeFloatToDouble(mercatorCenter.y);\r\n        const uMercatorCenterHigh = gl.getUniformLocation(program, \"u_mercatorCenterHigh\");\r\n        gl.uniform2f(uMercatorCenterHigh, mercatorCenterX[0], mercatorCenterY[0]);\r\n        const uMercatorCenterLow = gl.getUniformLocation(program, \"u_mercatorCenterLow\");\r\n        gl.uniform2f(uMercatorCenterLow, mercatorCenterX[1], mercatorCenterY[1]);\r\n        const uMatrix = gl.getUniformLocation(program, \"u_matrix\");\r\n        const relativeToEyeMatrix = matrix.slice();\r\n        relativeToEyeMatrix[12] += relativeToEyeMatrix[0] * mercatorCenter.x + relativeToEyeMatrix[4] * mercatorCenter.y;\r\n        relativeToEyeMatrix[13] += relativeToEyeMatrix[1] * mercatorCenter.x + relativeToEyeMatrix[5] * mercatorCenter.y;\r\n        relativeToEyeMatrix[14] += relativeToEyeMatrix[2] * mercatorCenter.x + relativeToEyeMatrix[6] * mercatorCenter.y;\r\n        relativeToEyeMatrix[15] += relativeToEyeMatrix[3] * mercatorCenter.x + relativeToEyeMatrix[7] * mercatorCenter.y;\r\n        gl.uniformMatrix4fv(uMatrix, false, relativeToEyeMatrix);\r\n\r\n        gl.bindVertexArray(VAO);\r\n        const symbolTextureLoc = gl.getUniformLocation(program, \"symbolTexture\");\r\n        const paletteTextureLoc = gl.getUniformLocation(program, \"paletteTexture\");\r\n        gl.activeTexture(gl.TEXTURE0);\r\n        gl.bindTexture(gl.TEXTURE_2D, that.simpleTexture);\r\n        gl.uniform1i(symbolTextureLoc, 0);\r\n        gl.activeTexture(gl.TEXTURE1);\r\n        gl.bindTexture(gl.TEXTURE_2D, that.paletteTexture);\r\n        gl.uniform1i(paletteTextureLoc, 1);\r\n\r\n        gl.drawArraysInstanced(gl.TRIANGLE_STRIP, 0, that.number, that.rotationArray.length);\r\n        // gl.drawArraysInstanced(\r\n        //   gl.POINTS,\r\n        //   0,\r\n        //   1,\r\n        //   1\r\n        // );\r\n\r\n        gl.bindVertexArray(null);\r\n        gl.bindTexture(gl.TEXTURE_2D, null);\r\n      },\r\n    };\r\n    return result;\r\n  }\r\n}\r\n","import { defineComponent, onMounted, ref } from \"vue\";\nimport mapBoxGl from \"mapbox-gl\";\nimport \"mapbox-gl/dist/mapbox-gl.css\";\nimport axios from \"axios\";\nimport { SymbolHandle } from \"@/utils/symbol-utils\";\nexport default defineComponent({\n  setup() {\n    const container = ref();\n    let map;\n    const symbolHandle = new SymbolHandle(64, 40);\n    const initResource = async () => {\n      await symbolHandle.getShader(`${process.env.VUE_APP_RESOURCE_PREFIX}/symbol/shader/symbol.vert.glsl`, \"vertex\");\n      await symbolHandle.getShader(`${process.env.VUE_APP_RESOURCE_PREFIX}/symbol/shader/symbol.frag.glsl`, \"fragment\");\n      await symbolHandle.getTexture(`${process.env.VUE_APP_RESOURCE_PREFIX}/symbol/texture/strip_z.png`, \"strip\");\n      await symbolHandle.getTexture(`${process.env.VUE_APP_RESOURCE_PREFIX}/symbol/texture/palette_z.png`, \"palette\");\n      await symbolHandle.getData(`${process.env.VUE_APP_RESOURCE_PREFIX}/symbol/json/output.geojson`, `${process.env.VUE_APP_RESOURCE_PREFIX}/symbol/json/tbvs_z.json`);\n    };\n    const initMap = () => {\n      const mapOpt = {\n        container: container.value,\n        // style: \"mapbox://styles/johnnyt/clblx2t3v000a14proaq4e9qv\",\n        center: [118.785067, 32.059148],\n        zoom: 8.8,\n        useWebGL2: true,\n        antialias: true,\n        accessToken: \"pk.eyJ1Ijoiam9obm55dCIsImEiOiJja2xxNXplNjYwNnhzMm5uYTJtdHVlbTByIn0.f1GfZbFLWjiEayI6hb_Qvg\",\n        style: \"mapbox://styles/johnnyt/cl9cj370u004714pcdxhynqc9\"\n        // style: \"mapbox://styles/johnnyt/clblx2t3v000a14proaq4e9qv\",\n        // style: {\n        //   version: 8,\n        //   sources: {\n        //     tdtVec: {\n        //       type: \"raster\",\n        //       tiles: [\n        //         \"http://t0.tianditu.com/vec_w/wmts?tk=35a94ab5985969d0b93229c30db6abd6&SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=vec&STYLE=default&TILEMATRIXSET=w&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&FORMAT=tiles\",\n        //       ],\n        //       tileSize: 256,\n        //     },\n        //     txt: {\n        //       type: \"raster\",\n        //       tiles: [\n        //         \"http://t0.tianditu.com/cva_w/wmts?tk=35a94ab5985969d0b93229c30db6abd6&SERVICE=WMTS&REQUEST=GetTile&VERSION=1.0.0&LAYER=cva&STYLE=default&TILEMATRIXSET=w&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}&FORMAT=tiles\",\n        //       ],\n        //       tileSize: 256,\n        //     },\n        //   },\n        //   layers: [\n        //     {\n        //       id: \"tdtVec\",\n        //       type: \"raster\",\n        //       source: \"tdtVec\",\n        //     },\n        //     {\n        //       id: \"txt\",\n        //       type: \"raster\",\n        //       source: \"txt\",\n        //     },\n        //   ],\n        // },\n      };\n\n      map = new mapBoxGl.Map(mapOpt);\n      map.on(\"load\", async () => {\n        map.addLayer(symbolHandle.generateCustomLayer(\"symbol\", map));\n        const crossroad = await axios.get(`${process.env.VUE_APP_RESOURCE_PREFIX}/symbol/json/crossroad_NJ.geojson`).then(res => res.data);\n        map.loadImage(`${process.env.VUE_APP_RESOURCE_PREFIX}/symbol/texture/交叉路口.png`, (err, image) => {\n          map.addImage(\"crossroad\", image);\n          map.addSource(\"pointCrossroad\", {\n            type: \"geojson\",\n            data: crossroad\n          });\n          map.addLayer({\n            id: \"pointCrossroad\",\n            type: \"symbol\",\n            source: \"pointCrossroad\",\n            layout: {\n              \"icon-image\": \"crossroad\",\n              \"icon-size\": 0.3,\n              //   \"icon-allow-overlap\": true,\n              \"icon-ignore-placement\": true,\n              \"icon-rotate\": 0\n            }\n          });\n        });\n      });\n    };\n    onMounted(async () => {\n      await initResource();\n      initMap();\n    });\n    return {\n      container\n    };\n  }\n});","/* unplugin-vue-components disabled */import { render } from \"./MapboxSymbolInstance.vue?vue&type=template&id=34464bf0&scoped=true&ts=true\"\nimport script from \"./MapboxSymbolInstance.vue?vue&type=script&lang=ts\"\nexport * from \"./MapboxSymbolInstance.vue?vue&type=script&lang=ts\"\n\nimport \"./MapboxSymbolInstance.vue?vue&type=style&index=0&id=34464bf0&scoped=true&lang=scss\"\n\nimport exportComponent from \"../../node_modules/vue-loader/dist/exportHelper.js\"\nconst __exports__ = /*#__PURE__*/exportComponent(script, [['render',render],['__scopeId',\"data-v-34464bf0\"]])\n\nexport default __exports__"],"names":["_hoisted_1","class","ref","render","_ctx","_cache","$props","$setup","$data","$options","SymbolHandle","constructor","number","symbolPixel","_defineProperty","mat4","this","modelMatrix","window","devicePixelRatio","getShader","address","type","shaderScript","axios","get","then","res","data","vertexScript","fragmentScript","getTexture","Promise","resolve","reject","image","Image","src","onload","palette","strip","getData","positionJsonAddress","infoJsonAddress","positionPromise","infoPromise","all","arr","markers","description","i","length","name","instanceNum","Math","ceil","j","features","item","coord","MercatorCoordinate","fromLngLat","lng","geometry","coordinates","lat","k","simpleArray","push","base","ID","positionX","encodeFloatToDouble","x","positionY","y","position","rotationArray","randomNumber","floor","random","rotation","myBindTexture","gl","simpleTexture","createTexture","bindTexture","TEXTURE_2D","texImage2D","RGBA","UNSIGNED_BYTE","texParameteri","TEXTURE_WRAP_S","CLAMP_TO_EDGE","TEXTURE_WRAP_T","TEXTURE_MIN_FILTER","LINEAR","TEXTURE_MAG_FILTER","paletteTexture","generateCustomLayer","id","map","program","VAO","that","result","onAdd","vertexShader","createShader","VERTEX_SHADER","shaderSource","compileShader","fragmentShader","FRAGMENT_SHADER","createProgram","attachShader","linkProgram","createVertexArray","bindVertexArray","VBO","createBuffer","bindBuffer","ARRAY_BUFFER","bufferData","Float32Array","DYNAMIC_DRAW","enableVertexAttribArray","vertexAttribPointer","FLOAT","vertexAttribDivisor","call","matrix","useProgram","uSymbolMatrix","getUniformLocation","uniformMatrix4fv","uBufferSize","uniform2f","canvas","width","height","center","getCenter","mercatorCenter","mapBoxGl","mercatorCenterX","mercatorCenterY","uMercatorCenterHigh","uMercatorCenterLow","uMatrix","relativeToEyeMatrix","slice","symbolTextureLoc","paletteTextureLoc","activeTexture","TEXTURE0","uniform1i","TEXTURE1","drawArraysInstanced","TRIANGLE_STRIP","setup","container","symbolHandle","initResource","async","initMap","mapOpt","value","zoom","useWebGL2","antialias","accessToken","style","on","addLayer","crossroad","loadImage","err","addImage","addSource","source","layout","__exports__"],"sourceRoot":""}